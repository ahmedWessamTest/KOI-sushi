@if (order) {
  <div class="card">
    <div class="flex justify-between items-center">
      <h2 class="text-2xl font-semibold mb-4">
        {{ order.order.user.name }}'s Order
      </h2>
      <div class="flex justify-end">
        <button
          icon="pi pi-angle-double-left"
          pButton
          label="Back"
          class="p-button-text"
          (click)="backToOrders()"
        ></button>
      </div>
    </div>
    <!-- User Details -->
    <p-card header="User Details" styleClass="shadow-lg border">
      <p-table
        [value]="userDetails"
        [paginator]="false"
        [rows]="5"
        responsiveLayout="scroll"
      >
        <ng-template pTemplate="header">
          <tr>
            <th class="text-center">ID</th>
            <th class="text-center">Name</th>
            <th class="text-center">Phone</th>
            <th class="text-center">Email</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-user>
          <tr>
            <td class="text-center">{{ user.id }}</td>
            <td class="text-center">{{ user.name }}</td>
            <td class="text-center">{{ user.phone }}</td>
            <td class="text-center">
              {{ user.email }}
            </td>
          </tr>
        </ng-template>
      </p-table>
    </p-card>

    <!-- Order Details -->
    <p-card header="Order Details" styleClass="shadow-lg border">
      <p-table
        [value]="userDetails"
        [paginator]="false"
        [rows]="5"
        responsiveLayout="scroll"
      >
        <ng-template pTemplate="header">
          <tr>
            <th class="text-center">ID</th>
            <th class="text-center">Date</th>
            <th class="text-center">Time</th>
            <th class="text-center">Status</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-user>
          <tr>
            <td class="text-center">{{ order.order.id }}</td>
            <td class="text-center">
              {{ order.order.created_at | date: "dd/MM/yyyy" }}
            </td>
            <td class="text-center">
              {{ order.order.created_at | date: "hh:mm a" }}
            </td>
            <td [ngClass]="getStatusClass(order.order.status)">
              <div class="mt-3">
                <p-dropdown
                  [filter]="true"
                  [options]="getAvailableStatusOptions(order.order.status)"
                  [(ngModel)]="order.order.status"
                  (onChange)="updateOrderStatus(order.order, true)"
                  placeholder="Update Status"
                  optionLabel="label"
                  optionValue="value"
                >
                  <!-- ✅ Selected item template (fixes missing icon when selecting) -->
                  <ng-template pTemplate="selectedItem" let-selected>
                    <i [class]="selected.icon" class="mr-2"></i>
                    {{ selected.label }}
                  </ng-template>

                  <!-- ✅ Dropdown item template (fixes missing icon inside dropdown list) -->
                  <ng-template pTemplate="item" let-option>
                    <i [class]="option.icon" class="mr-2"></i>
                    {{ option.label }}
                  </ng-template>
                </p-dropdown>
              </div>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </p-card>

    <!-- Address Details -->
    <p-card header="Address Details" styleClass="shadow-lg border">
      <p-table
        [value]="userAddress"
        [paginator]="false"
        [rows]="5"
        responsiveLayout="scroll"
        styleClass="fixed-width-table"
      >
        <ng-template pTemplate="header">
          <tr>
            <th class="text-center">City</th>
            <th class="text-center">Area</th>
            <th class="text-center">Address Info</th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-user>
          <tr>
            <td class="text-center">
              {{ order.order.address.region.governorate.title_en }}
            </td>
            <td
              [title]="order.order.address.region.title_en"
              class="text-center text-wrap word-break"
            >
              {{ order.order.address.region.title_en }}
            </td>
            <td
              [title]="order.order.address.address"
              class="text-center text-wrap word-break"
            >
              {{ order.order.address.address }}
            </td>
          </tr>
        </ng-template>
      </p-table>
    </p-card>
    <!-- Address Note -->
    @if (order.order.address.note) {
      <p-card header="Address Note" styleClass="shadow-lg border">
        <p-table [value]="[order.order]" responsiveLayout="scroll">
          <ng-template pTemplate="header">
            <tr>
              <th class="text-center">Address Note</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-order>
            <tr>
              <td class="text-center text-wrap">{{ order.address.note }}</td>
            </tr>
          </ng-template>
        </p-table>
      </p-card>
    }
    <!-- Promo Details -->
    @if (order.order.promo_code) {
      <p-card header="Promo Code" styleClass="shadow-lg border">
        <p-table
          [value]="userPromoCode"
          [paginator]="false"
          [rows]="5"
          responsiveLayout="scroll"
        >
          <ng-template pTemplate="header" let-code>
            <tr>
              <th class="text-center">ID</th>
              <th class="text-center">Code</th>
              <th class="text-center">Code Value</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-code>
            <tr>
              <td class="text-center">{{ code.id }}</td>
              <td class="text-center">{{ code.code }}</td>
              <td class="text-center">
                {{
                  code.type === "percentage"
                    ? (convertStringToNumber(code.value) / 100 | percent)
                    : (code.value | currency: " EGP ")
                }}
              </td>
            </tr>
          </ng-template>
        </p-table>
      </p-card>
    }
    @if (order.order.voucher) {
      <p-card header="Voucher" styleClass="shadow-lg border">
        <p-table [value]="[order.order.voucher]" [paginator]="false" [rows]="5">
          <ng-template pTemplate="header">
            <tr>
              <th class="text-center">ID</th>
              <th class="text-center">Voucher</th>
              <th class="text-center">Voucher Value</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-voucher>
            <tr>
              <td class="text-center">{{ voucher.id }}</td>
              <td class="text-center">{{ voucher.title_en }}</td>
              <td class="text-center">
                {{
                  voucher.type === "percentage"
                    ? (convertStringToNumber(voucher.value) / 100 | percent)
                    : (voucher.value | currency: " EGP ")
                }}
              </td>
            </tr>
          </ng-template>
        </p-table>
      </p-card>
    }
    @if (isHaveCombo) {
      <p-card header="Combo Details" styleClass="shadow-lg border">
        <p-table [value]="order.order.items" responsiveLayout="scroll">
          <ng-template pTemplate="header">
            <tr>
              <th class="text-center">Combo Name</th>
              <th class="text-center">Combo Pieces</th>
              <th class="text-center">Combo Value</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-item>
            @if (item.combo_offer) {
              <tr>
                <td class="text-center">
                  {{ item.combo_offer.combo.title_en }}
                </td>
                <td class="text-center">
                  {{ item.combo_offer.combo.pieces }}
                </td>
                <td class="text-center">
                  {{ item.combo_offer.combo.price | currency: " EGP " }}
                </td>
              </tr>
            }
          </ng-template>
        </p-table>
      </p-card>
    }

    @if (order.order.note) {
      <p-card header="Order Notes" styleClass="shadow-lg border">
        <p-table [value]="[order.order]" responsiveLayout="scroll">
          <ng-template pTemplate="header">
            <tr>
              <th class="text-center">Order Note</th>
            </tr>
          </ng-template>
          <ng-template pTemplate="body" let-order>
            <tr>
              <td class="text-center text-wrap">{{ order.note }}</td>
            </tr>
          </ng-template>
        </p-table>
      </p-card>
    }
    <p-card header="Cart Details" styleClass="shadow-lg border">
      <p-table [value]="userOrders" responsiveLayout="scroll">
        <ng-template pTemplate="header">
          <tr>
            <th class="text-center">#</th>
            <th class="text-center">Cart Item</th>
            <th class="text-center">Quantity</th>
            <th class="text-center">Category</th>
            <th class="text-center">Product Option</th>
            <th class="text-center">Price</th>
          </tr>
        </ng-template>

        <ng-template pTemplate="body" let-item let-i="rowIndex">
          <tr>
            <td class="text-center">{{ i + 1 }}</td>
            <td class="text-center">{{ item?.product?.title_en }}</td>
            <td class="text-center">{{ item?.quantity }}</td>
            <td class="text-center">{{ item?.product?.category?.title_en }}</td>
            <td class="text-center">{{ item?.product_option?.title_en }}</td>
            <td class="text-center">
              {{ item.price * item.quantity | currency: " EGP " }}
            </td>
          </tr>
        </ng-template>

        <ng-template pTemplate="footer">
          <tr>
            <td colspan="5" class="text-right font-bold">Subtotal:</td>
            <td class="text-center font-bold">
              {{ order.order.sub_total_price | currency: " EGP " }}
            </td>
          </tr>
          <tr>
            <td colspan="5" class="text-right font-bold">VAT:</td>
            <td class="text-center font-bold">
              <span class="flex items-center justify-center gap-2">
                <p-badge
                  [value]="order.order.tax | currency: ' EGP '"
                  severity="warning"
                  styleClass="mr-2"
                  pTooltip="VAT percentage"
                  tooltipPosition="top"
                  aria-label="VAT percentage"
                ></p-badge>
                <p-badge
                  [value]="
                    convertStringToNumber(order.order.tax_percentage) / 100
                      | percent
                  "
                  severity="warning"
                  styleClass="mr-2"
                  pTooltip="VAT percentage"
                  tooltipPosition="top"
                  aria-label="VAT percentage"
                ></p-badge>
              </span>
            </td>
          </tr>
          @if (order.order.loyalty_points_discount) {
            <tr>
              <td colspan="5" class="text-right font-bold">Loyalty Points:</td>
              <td class="text-center font-bold">
                <span class="flex items-center justify-center gap-2">
                  <p-badge
                    [value]="order.order.loyalty_points_discount"
                    severity="contrast"
                    pTooltip="Loyalty Points"
                    tooltipPosition="top"
                    aria-label="LoyaltyPoints"
                  ></p-badge>
                </span>
              </td>
            </tr>
          }
          @if (convertStringToNumber(order.order.happy_hours_discount)) {
            <tr>
              <td colspan="5" class="text-right font-bold">happy hours:</td>
              <td class="text-center font-bold">
                <span class="flex items-center justify-center gap-2">
                  <p-badge
                    [value]="
                      convertStringToNumber(order.order.happy_hours_discount)
                        | currency: ' EGP '
                    "
                    severity="contrast"
                    pTooltip="happy hours"
                    tooltipPosition="top"
                    aria-label="happy hours"
                  ></p-badge>
                </span>
              </td>
            </tr>
          }

          @if (order.order.loyalty_points_discount) {
            <tr>
              <td colspan="5" class="text-right font-bold text-lg">
                promo code
              </td>
              <td class="text-center font-bold text-lg">
                <span class="flex items-center justify-center gap-2">
                  <p-badge
                    [value]="
                      '-' + order.order.loyalty_points_discount
                        | currency: ' EGP '
                    "
                    severity="warning"
                    pTooltip="promo code value"
                    tooltipPosition="top"
                    aria-label="promo code value"
                  ></p-badge>
                </span>
              </td>
            </tr>
          }
          @if (order.order.delivery_fee) {
            <tr>
              <td colspan="5" class="text-right font-bold text-lg">
                Delivery:
              </td>
              <td class="text-center font-bold text-lg">
                <span class="flex items-center justify-center gap-2">
                  <p-badge
                    [value]="order.order.delivery_fee | currency: ' EGP '"
                    severity="danger"
                    pTooltip="Delivery charge"
                    tooltipPosition="top"
                    aria-label="Delivery charge"
                  ></p-badge>
                </span>
              </td>
            </tr>
          }
          <tr>
            <td colspan="5" class="text-right font-bold text-lg">Total:</td>
            <td class="text-center font-bold text-lg">
              {{ order.order.total_price | currency: " EGP " }}
            </td>
          </tr>
        </ng-template>
      </p-table>
    </p-card>
  </div>

  <!-- Print Button -->
  <button
    pButton
    label="Print Receipt"
    icon="pi pi-print"
    class="p-button-outlined"
    (click)="printOrderReceipt()"
  ></button>

  <!-- Order Receipt -->
  <p-card>
    <div id="receipt-section">
      <h2 class="text-center">Order Receipt</h2>
      <p><strong>Order ID:</strong> {{ order.order.id }}</p>
      <p><strong>Customer Name:</strong> {{ order.order.user.name }}</p>
      <p>
        <strong>Date:</strong> {{ order.order.created_at | date: "dd/MM/yyyy" }}
      </p>
      <p><strong>Full Address:</strong> {{ order.order.address.address }}</p>
      <p><strong>Address Note:</strong> {{ order.order.address.note }}</p>
      <p>
        <strong>sub Address:</strong> {{ order.order.address.region.title_en }}
      </p>
      <p>
        <strong>City:</strong>
        {{ order.order.address.region.governorate.title_en }}
      </p>
      <p><strong>Address Type:</strong> {{ order.order.address.type }}</p>
      @if (order.order.note) {
        <p><strong>Order Note:</strong> {{ order.order.note }}</p>
      }
      @if (order.order.user.phone) {
        <p><strong>phone number:</strong> {{ order.order.user.phone }}</p>
      }

      <p><strong>Status:</strong> {{ order.order.status }}</p>

      <table class="w-full border-collapse border">
        <thead>
          <tr>
            <th class="border p-2">Item</th>
            <th class="border p-2">Quantity</th>
            <th class="border p-2">Price</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of userOrders">
            <td class="border p-2">{{ item?.product?.title_en }}</td>
            <td class="border p-2">{{ item?.quantity }}</td>
            <td class="border p-2">{{ item?.price | currency: " EGP " }}</td>
          </tr>
        </tbody>
      </table>

      <div id="not-show-print" class="mt-4">
        <!-- Subtotal -->
        <p-card styleClass="mb-3">
          <div class="flex justify-between items-center">
            <div class="flex items-center gap-2">
              <i class="pi pi-shopping-cart text-primary"></i>
              <span class="font-bold">Subtotal</span>
            </div>
            <span class="font-bold text-primary">{{
              order.order.sub_total_price | currency: " EGP "
            }}</span>
          </div>
        </p-card>

        <!-- Service Charge -->
        <!-- <p-card styleClass="mb-3">
        <div class="flex justify-between items-center">
          <div class="flex items-center gap-2">
            <i class="pi pi-percentage text-blue-500"></i>
            <span class="font-bold">Service Charge</span>
          </div>
          <div class="flex items-center gap-2">
            <p-badge
              [value]="order.order.service_value / 100 | percent"
              severity="info"
            ></p-badge>
            <span class="font-bold text-blue-500">{{
              order.order.service_money | currency : " EGP "
            }}</span>
          </div>
        </div>
      </p-card> -->
        <!-- Happy Hours  -->
        @if (convertStringToNumber(order.order.happy_hours_discount)) {
          <p-card styleClass="mb-3">
            <div class="flex justify-between items-center">
              <div class="flex items-center gap-2">
                <i class="pi pi-star text-pr text-pr"></i>
                <span class="font-bold">Happy Hours</span>
              </div>
              <div class="flex items-center gap-2">
                <span class="font-bold text-blue-500">{{
                  convertStringToNumber(order.order.happy_hours_discount)
                    | currency: " EGP "
                }}</span>
              </div>
            </div>
          </p-card>
        }
        <!-- Zi Points discount  -->
        @if (order.order.loyalty_points_discount) {
          <p-card styleClass="mb-3">
            <div class="flex justify-between items-center">
              <div class="flex items-center gap-2">
                <i class="pi pi-trophy text-pr text-pr"></i>
                <span class="font-bold">Loyalty Points</span>
              </div>
              <div class="flex items-center gap-2">
                <span class="font-bold text-blue-500">{{
                  order.order.loyalty_points_discount | currency: " EGP "
                }}</span>
              </div>
            </div>
          </p-card>
        }

        <!-- VAT -->
        <p-card styleClass="mb-3">
          <div class="flex justify-between items-center">
            <div class="flex items-center gap-2">
              <i class="pi pi-chart-line text-orange-500"></i>
              <span class="font-bold">VAT</span>
            </div>
            <div class="flex items-center gap-2">
              <p-badge
                [value]="
                  convertStringToNumber(order.order.tax_percentage) / 100
                    | percent
                "
                severity="warning"
              ></p-badge>
              <span class="font-bold text-blue-500">{{
                order.order.tax | currency: " EGP "
              }}</span>
            </div>
          </div>
        </p-card>

        <!-- Delivery -->
        @if (order.order.delivery_fee) {
          <p-card styleClass="mb-3">
            <div class="flex justify-between items-center">
              <div class="flex items-center gap-2">
                <i class="pi pi-truck text-green-500"></i>
                <span class="font-bold">Delivery</span>
              </div>
              <span class="font-bold text-blue-500">{{
                order.order.delivery_fee | currency: " EGP "
              }}</span>
            </div>
          </p-card>
        }

        <!-- Promo Code -->
        @if (order.order.promo_code_discount) {
          <p-card styleClass="mb-3">
            <div class="flex justify-between items-center">
              <div class="flex items-center gap-2">
                <i class="pi pi-ticket text-purple-500"></i>
                <span class="font-bold">Promo Code</span>
              </div>
              <span class="font-bold text-red-500">{{
                "-" + order.order.promo_code_discount | currency: " EGP "
              }}</span>
            </div>
          </p-card>
        }
        <!-- Total -->
        <p-card styleClass="bg-primary-50 border-primary">
          <div class="flex justify-between items-center">
            <div class="flex items-center gap-2">
              <i class="pi pi-wallet text-primary"></i>
              <span class="font-bold text-lg">Total</span>
            </div>
            <span class="font-bold text-lg text-primary">{{
              order.order.total_price | currency: " EGP "
            }}</span>
          </div>
        </p-card>
      </div>
    </div>
  </p-card>
} @else {
  <app-loading-data-banner></app-loading-data-banner>ng s
}
