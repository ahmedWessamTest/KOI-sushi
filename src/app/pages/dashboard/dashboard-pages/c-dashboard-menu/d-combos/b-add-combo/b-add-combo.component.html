<p-card class="p-4">
  <ng-template pTemplate="title">
    <h2 class="text-xl font-semibold text-gray-800">{{ isEditing ? "Edit Product" : "Add Product" }}</h2>
  </ng-template>

  <ng-template pTemplate="content">
    <form [formGroup]="submitForm" class="grid md:grid-cols-1 gap-6">
      <div>
        <label class="font-medium mb-1 block">Product English Name</label>
        <input type="text" pInputText formControlName="title_en" class="p-inputtext-sm w-full" />
        @if (submitForm.get('title_en')?.invalid && submitForm.get('title_en')?.touched) {
        <div class="p-error">
          <small>Product English Name is required.</small>
        </div>
        }
      </div>

      <div>
        <label class="font-medium mb-1 block">Product Arabic Name</label>
        <input type="text" pInputText formControlName="title_ar" class="p-inputtext-sm w-full" />
        @if (submitForm.get('title_ar')?.invalid && submitForm.get('title_ar')?.touched) {
        <div class="p-error">
          <small>Product Arabic Name is required.</small>
        </div>
        }
      </div>

      <div>
        <label class="font-medium mb-1 block">Product Price</label>
        <input appOnlyNumber type="number" pInputText formControlName="price" class="p-inputtext-sm w-full" />
        @if (submitForm.get('price')?.invalid && submitForm.get('price')?.touched) {
        <div class="p-error">
          <small>Product Price is required.</small>
        </div>
        }
      </div>
      <div>
        <label class="font-medium mb-1 block">Product Pieces</label>
        <input appOnlyNumber type="number" pInputText formControlName="pieces" class="p-inputtext-sm w-full" />
        @if (submitForm.get('pieces')?.invalid && submitForm.get('pieces')?.touched) {
        <div class="p-error">
          <small>Product Pieces is required.</small>
        </div>
        }
      </div>
      

      <!-- InputSwitch State -->
      <!-- <div class="flex items-center gap-2">
        <p-inputSwitch [trueValue]="1" [falseValue]="0" formControlName="state"></p-inputSwitch>
        <label class="font-medium mb-1 block">Status</label>
      </div> -->

      <!-- Dynamic Piece Price Inputs -->
       
      <div formArrayName="combo_categories" class="mt-4">
  <div class="flex justify-between items-center mb-3">
    <label class="font-bold text-lg">Combo Categories Configuration</label>
    <button pButton label="Add Category" icon="pi pi-plus" class="p-button-sm p-button-outlined" (click)="addPiecePrice()"></button>
  </div>

  @for (control of comboCategoryArray.controls; track $index) {
  <div [formGroup]="control" class="grid grid-cols-12 gap-3 border-bottom pb-3 mb-3 items-end">
    
    <div class="col-span-4">
      <label class="block mb-1">Select Category</label>
      <p-dropdown 
        [options]="categories" 
        formControlName="category_id" 
        optionLabel="title_en" 
        optionValue="id"
        placeholder="Select Category"
        styleClass="w-full"
        (onChange)="onCategoryChange($event.value, $index)">
      </p-dropdown>
    </div>

    <div class="col-span-4">
      <label class="block mb-1">Excludes (Optional)</label>
      <p-multiSelect 
        [options]="productsByRow[$index]" 
        formControlName="combo_category_excludes" 
        optionLabel="title_en" 
        optionValue="id"
        placeholder="Select Products"
        styleClass="w-full" display="chip" [loading]="loadingProducts">
      </p-multiSelect>
    </div>

    <div class="col-span-3">
      <label class="block mb-1">Limit</label>
      <input 
        type="number" 
        pInputText 
        formControlName="limit" 
        placeholder="Max pieces" 
        class="w-full" />
    </div>

    <div class="col-span-1">
      <button pButton icon="pi pi-trash" class="p-button-danger p-button-text" (click)="removePiecePrice($index)"></button>
    </div>
  </div>
  }

  @if (submitForm.get('combo_categories')?.invalid && submitForm.get('combo_categories')?.touched) {
    <small class="p-error block mt-2">At least one category configuration is required.</small>
  }
</div>
      

     
    </form>

    @if (errorMessage.length > 0) {
    <div class="my-3 bg-red-100 border-l-4 border-red-500 text-red-700 p-4" role="alert">
      <p class="font-bold">Something Wrong!</p>
      <p>{{ errorMessage }}</p>
    </div>
    }
  </ng-template>

  <ng-template pTemplate="footer">
    <div class="flex justify-end gap-3 mt-4">
      <button
        icon="pi pi-times"
        pButton
        label="Cancel"
        class="p-button-text"
        routerLink="/dashboard/menu/products"></button>
      <button pButton label="Save" (click)="saveForm()" class="p-button-success btn-main px-3"></button>
    </div>
  </ng-template>
</p-card>
